@page "/livros/adicionar"
@using TheosLivraria.Web.Request.Livros
@using TheosLivraria.Web.ServicesAPI
@inject ILivroService LivroService
@inject NavigationManager NavigationManager
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage

<RadzenCard Style="max-width:500px;margin:auto;margin-top:32px;">
    <h3 style="text-align:center;">Adicionar Livro</h3>
    <div style="margin-bottom:16px;">
        <RadzenTextBox @bind-Value="livro.Titulo" Name="Titulo" Placeholder="Título" Style="width:100%;" />
        @if (showValidation && string.IsNullOrWhiteSpace(livro.Titulo))
        {
            <RadzenAlert Severity="AlertSeverity.Error" Summary="Título obrigatório" />
        }
    </div>
    <div style="margin-bottom:16px;">
        <RadzenTextBox @bind-Value="livro.Autor" Name="Autor" Placeholder="Autor" Style="width:100%;" />
        @if (showValidation && string.IsNullOrWhiteSpace(livro.Autor))
        {
            <RadzenAlert Severity="AlertSeverity.Error" Summary="Autor obrigatório" />
        }
    </div>
    <div style="margin-bottom:16px;">
        <RadzenTextBox @bind-Value="livro.Isbn" Name="Isbn" Placeholder="ISBN" Style="width:100%;" />
        @if (showValidation && string.IsNullOrWhiteSpace(livro.Isbn))
        {
            <RadzenAlert Severity="AlertSeverity.Error" Summary="ISBN obrigatório" />
        }
    </div>
    <div style="margin-bottom:16px;">
        <RadzenNumeric @bind-Value="livro.Preco" Name="Preco" Placeholder="Preço" Style="width:100%;" />
        @if (showValidation && livro.Preco <= 0)
        {
            <RadzenAlert Severity="AlertSeverity.Error" Summary="Preço obrigatório" />
        }
    </div>
    <div style="margin-bottom:16px;">
        <RadzenNumeric @bind-Value="livro.Estoque" Name="Estoque" Placeholder="Estoque" Style="width:100%;" />
        @if (showValidation && livro.Estoque < 0)
        {
            <RadzenAlert Severity="AlertSeverity.Error" Summary="Estoque obrigatório" />
        }
    </div>
    <RadzenButton Text="Salvar" Style="width:100%;margin-top:8px;" Click="@AdicionarLivro" />
    <RadzenButton Text="Cancelar" Style="width:100%;margin-top:8px;" ButtonStyle="ButtonStyle.Secondary" Click="@(() => NavigationManager.NavigateTo("/livros"))" />
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <RadzenAlert Severity="AlertSeverity.Error" Summary="Erro" Detail="@errorMessage" Style="margin-top:16px;" />
    }
    @if (sucesso)
    {
        <RadzenAlert Severity="AlertSeverity.Success" Summary="Sucesso" Detail="Livro adicionado com sucesso!" Style="margin-top:16px;" />
    }
</RadzenCard>

@code {
    private CriarLivroRequest livro = new();
    private string? errorMessage;
    private bool sucesso = false;
    private bool showValidation = false;

    private async Task AdicionarLivro()
    {
        errorMessage = null;
        sucesso = false;
        showValidation = true;

        if (string.IsNullOrWhiteSpace(livro.Titulo) ||
            string.IsNullOrWhiteSpace(livro.Autor) ||
            string.IsNullOrWhiteSpace(livro.Isbn) ||
            livro.Preco <= 0 ||
            livro.Estoque < 0)
        {
            return;
        }

        try
        {
            var token = await LocalStorage.GetItemAsync<string>("theosAuthToken");
            var httpClient = new HttpClient();
            httpClient.BaseAddress = new Uri("https://localhost:7187");
            httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var livroService = Refit.RestService.For<ILivroService>(httpClient);
            var result = await livroService.Criar(livro);
            if (result.Success)
            {
                sucesso = true;
                NavigationManager.NavigateTo("/livros");
            }
            else
            {
                errorMessage = result.Message ?? "Erro ao adicionar livro.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao adicionar livro: {ex.Message}";
        }
    }
}